# Webhook Integration Guide: Make.com â†’ Airtable

## Overview

UpsurgeIQ now sends real-time webhook notifications to Make.com whenever users register or complete onboarding. This allows you to automatically sync user data to Airtable or any other system connected through Make.com scenarios.

---

## Quick Start

### 1. Create Make.com Webhook

1. Log into [Make.com](https://www.make.com)
2. Create a new scenario
3. Add "Webhooks" â†’ "Custom webhook" as the first module
4. Copy the webhook URL (looks like: `https://hook.us1.make.com/xxxxxxxxxxxxx`)

### 2. Configure Webhook in UpsurgeIQ

**Option A: Via Database (Recommended for initial setup)**

Run this SQL in your database:

```sql
INSERT INTO webhook_configs (name, eventType, webhookUrl, isActive, retryAttempts)
VALUES ('Onboarding to Airtable', 'user.onboarded', 'YOUR_MAKE_WEBHOOK_URL', 1, 3);
```

**Option B: Via Admin API (Coming Soon)**

A webhook management UI will be added to the admin dashboard for easier configuration.

### 3. Set Up Make.com Scenario

1. Use the webhook module to receive data
2. Add "Airtable" â†’ "Create a record" module
3. Map the webhook fields to your Airtable columns (see Field Mapping below)
4. Save and activate the scenario

---

## Webhook Events

### Event 1: `user.registered`

**Trigger:** When a new user completes OAuth registration

**Payload Structure:**
```json
{
  "event": "user.registered",
  "timestamp": "2025-12-19T15:30:00.000Z",
  "user": {
    "id": 123,
    "email": "john@example.com",
    "name": "John Smith",
    "createdAt": "2025-12-19T15:30:00.000Z"
  }
}
```

**Use Cases:**
- Send welcome email via Make.com
- Add to CRM or marketing automation
- Track user acquisition metrics

---

### Event 2: `user.onboarded` â­ PRIMARY EVENT

**Trigger:** When a user completes the business onboarding wizard

**Payload Structure:**
```json
{
  "event": "user.onboarded",
  "timestamp": "2025-12-19T15:35:00.000Z",
  "user": {
    "id": 123,
    "email": "john@example.com",
    "name": "John Smith"
  },
  "business": {
    "id": 456,
    "companyName": "Acme Corp",
    "website": "https://acme.com",
    "industry": "Technology",
    "sicCode": "62",
    "sicDescription": "Computer programming, consultancy and related activities",
    "employeeCount": null,
    "targetAudience": "SMB technology companies",
    "uniqueSellingPoints": null,
    "brandVoice": "professional",
    "toneStyle": "concise",
    "keyMessages": null,
    "competitorInfo": null,
    "imageStyle": "modern",
    "colorPreferences": "blue, white",
    "logoUrl": null,
    "createdAt": "2025-12-19T15:35:00.000Z"
  },
  "subscription": {
    "tier": "pro",
    "status": "active",
    "startDate": "2025-12-19T15:35:00.000Z"
  }
}
```

**Use Cases:**
- Sync complete business profile to Airtable
- Trigger onboarding email sequence
- Notify sales team of new customer
- Update CRM with business details

---

## Airtable Field Mapping

### Recommended Airtable Base Structure

**Table Name:** `UpsurgeIQ Customers`

| Airtable Field | Type | Maps to Webhook Field |
|---|---|---|
| User ID | Number | `user.id` |
| Email | Email | `user.email` |
| Name | Single line text | `user.name` |
| Company Name | Single line text | `business.companyName` |
| Website | URL | `business.website` |
| Industry | Single line text | `business.industry` |
| SIC Code | Single line text | `business.sicCode` |
| SIC Description | Long text | `business.sicDescription` |
| Target Audience | Long text | `business.targetAudience` |
| Brand Voice | Single select | `business.brandVoice` |
| Tone Style | Single select | `business.toneStyle` |
| Image Style | Single line text | `business.imageStyle` |
| Color Preferences | Single line text | `business.colorPreferences` |
| Subscription Tier | Single select | `subscription.tier` |
| Subscription Status | Single select | `subscription.status` |
| Onboarded At | Date | `timestamp` |
| Created At | Date | `user.createdAt` |

### Brand Voice Values (Single Select)
- formal
- friendly
- inspirational
- witty
- educational

### Tone Style Values (Single Select)
- concise
- detailed
- story_driven
- data_driven

### Subscription Tier Values (Single Select)
- starter
- pro
- scale

### Subscription Status Values (Single Select)
- active
- canceled
- past_due
- trialing

---

## Make.com Scenario Example

### Basic Scenario: Webhook â†’ Airtable

**Modules:**

1. **Webhooks â†’ Custom webhook**
   - Webhook URL: (generated by Make.com)
   - Data structure: JSON

2. **Airtable â†’ Create a record**
   - Base: Your Airtable base
   - Table: `UpsurgeIQ Customers`
   - Field mappings:
     ```
     User ID: {{1.user.id}}
     Email: {{1.user.email}}
     Name: {{1.user.name}}
     Company Name: {{1.business.companyName}}
     Website: {{1.business.website}}
     Industry: {{1.business.industry}}
     SIC Code: {{1.business.sicCode}}
     SIC Description: {{1.business.sicDescription}}
     Target Audience: {{1.business.targetAudience}}
     Brand Voice: {{1.business.brandVoice}}
     Tone Style: {{1.business.toneStyle}}
     Image Style: {{1.business.imageStyle}}
     Color Preferences: {{1.business.colorPreferences}}
     Subscription Tier: {{1.subscription.tier}}
     Subscription Status: {{1.subscription.status}}
     Onboarded At: {{1.timestamp}}
     ```

3. **Save and activate scenario**

---

## Advanced Scenarios

### Scenario 1: Onboarding + Email Notification

**Flow:** Webhook â†’ Airtable â†’ SendGrid/Mailchimp

1. Receive webhook
2. Create Airtable record
3. Send personalized welcome email with business details
4. Add to email marketing list based on subscription tier

### Scenario 2: Onboarding + Slack Notification

**Flow:** Webhook â†’ Airtable â†’ Slack

1. Receive webhook
2. Create Airtable record
3. Post to Slack channel: "New customer: {companyName} ({tier} plan)"

### Scenario 3: Onboarding + CRM Sync

**Flow:** Webhook â†’ Airtable â†’ HubSpot/Salesforce

1. Receive webhook
2. Create Airtable record
3. Create/update contact in CRM
4. Create deal/opportunity based on subscription tier

---

## Webhook Configuration

### Database Schema

**Table:** `webhook_configs`

| Field | Type | Description |
|---|---|---|
| id | INT | Primary key |
| name | VARCHAR(255) | Descriptive name (e.g., "Onboarding to Airtable") |
| eventType | ENUM | `user.registered` or `user.onboarded` |
| webhookUrl | VARCHAR(1000) | Make.com webhook URL |
| isActive | INT | 1 = active, 0 = disabled |
| retryAttempts | INT | Number of retry attempts (1-5, default: 3) |
| createdAt | TIMESTAMP | When webhook was configured |
| updatedAt | TIMESTAMP | Last update timestamp |

### Multiple Webhooks

You can configure multiple webhooks for the same event type. For example:

```sql
-- Webhook 1: Send to Airtable
INSERT INTO webhook_configs (name, eventType, webhookUrl, isActive, retryAttempts)
VALUES ('Onboarding to Airtable', 'user.onboarded', 'https://hook.us1.make.com/xxxxx', 1, 3);

-- Webhook 2: Send to Slack
INSERT INTO webhook_configs (name, eventType, webhookUrl, isActive, retryAttempts)
VALUES ('Onboarding to Slack', 'user.onboarded', 'https://hook.us1.make.com/yyyyy', 1, 3);
```

Both webhooks will fire when a user completes onboarding.

---

## Webhook Delivery

### Retry Logic

- **Automatic retries:** If webhook delivery fails, the system will retry automatically
- **Retry attempts:** Configurable (1-5, default: 3)
- **Backoff strategy:** Exponential backoff (2s, 4s, 8s delays)
- **Timeout:** 30 seconds per attempt

### Delivery Logs

All webhook deliveries are logged in the `webhook_delivery_logs` table:

| Field | Type | Description |
|---|---|---|
| id | INT | Primary key |
| webhookConfigId | INT | Reference to webhook_configs |
| eventType | VARCHAR(50) | Event type that triggered webhook |
| payload | TEXT | Full JSON payload sent |
| success | INT | 1 = success, 0 = failure |
| statusCode | INT | HTTP status code from endpoint |
| errorMessage | TEXT | Error message if delivery failed |
| attempts | INT | Number of delivery attempts made |
| deliveredAt | TIMESTAMP | When delivery was attempted |
| createdAt | TIMESTAMP | Log entry creation time |

### Viewing Delivery Logs

```sql
-- View recent webhook deliveries
SELECT 
  wdl.*,
  wc.name as webhook_name,
  wc.eventType
FROM webhook_delivery_logs wdl
JOIN webhook_configs wc ON wdl.webhookConfigId = wc.id
ORDER BY wdl.deliveredAt DESC
LIMIT 50;

-- View failed deliveries
SELECT * FROM webhook_delivery_logs
WHERE success = 0
ORDER BY deliveredAt DESC;
```

---

## Testing

### 1. Test Webhook Reception in Make.com

1. In Make.com, click "Run once" on your scenario
2. The webhook module will wait for data
3. In UpsurgeIQ, complete the onboarding flow
4. Make.com should receive the webhook data
5. Review the data structure and map fields accordingly

### 2. Test with Sample Payload

You can manually test your Make.com scenario by sending a sample payload:

```bash
curl -X POST https://hook.us1.make.com/YOUR_WEBHOOK_ID \
  -H "Content-Type: application/json" \
  -d '{
    "event": "user.onboarded",
    "timestamp": "2025-12-19T15:35:00.000Z",
    "user": {
      "id": 999,
      "email": "test@example.com",
      "name": "Test User"
    },
    "business": {
      "id": 888,
      "companyName": "Test Company",
      "website": "https://test.com",
      "industry": "Technology",
      "sicCode": "62",
      "sicDescription": "Computer programming",
      "employeeCount": null,
      "targetAudience": "Test audience",
      "uniqueSellingPoints": null,
      "brandVoice": "professional",
      "toneStyle": "concise",
      "keyMessages": null,
      "competitorInfo": null,
      "imageStyle": "modern",
      "colorPreferences": "blue",
      "logoUrl": null,
      "createdAt": "2025-12-19T15:35:00.000Z"
    },
    "subscription": {
      "tier": "pro",
      "status": "active",
      "startDate": "2025-12-19T15:35:00.000Z"
    }
  }'
```

---

## Troubleshooting

### Webhook Not Firing

**Check:**
1. Is the webhook active? (`isActive = 1` in database)
2. Is the webhook URL correct?
3. Check `webhook_delivery_logs` for error messages

**Solution:**
```sql
-- Check webhook status
SELECT * FROM webhook_configs WHERE eventType = 'user.onboarded';

-- Enable webhook if disabled
UPDATE webhook_configs SET isActive = 1 WHERE id = YOUR_WEBHOOK_ID;
```

### Make.com Not Receiving Data

**Check:**
1. Is the Make.com scenario active?
2. Is the webhook URL correct in `webhook_configs`?
3. Check Make.com scenario execution history

**Solution:**
- Copy the webhook URL from Make.com again
- Update in database:
```sql
UPDATE webhook_configs 
SET webhookUrl = 'NEW_WEBHOOK_URL' 
WHERE id = YOUR_WEBHOOK_ID;
```

### Delivery Failures

**Check delivery logs:**
```sql
SELECT * FROM webhook_delivery_logs 
WHERE success = 0 
ORDER BY deliveredAt DESC 
LIMIT 10;
```

**Common Issues:**
- **Timeout:** Make.com scenario taking too long (>30s)
- **Invalid URL:** Webhook URL is incorrect or expired
- **Make.com scenario error:** Check Make.com execution logs

**Solution:**
- Simplify Make.com scenario (remove slow modules)
- Increase retry attempts:
```sql
UPDATE webhook_configs SET retryAttempts = 5 WHERE id = YOUR_WEBHOOK_ID;
```

### Duplicate Records in Airtable

**Cause:** Webhook retries creating duplicate records

**Solution:**
- Use "Search records" module in Make.com before creating
- Check if record exists by `user.id` or `user.email`
- Only create if not found, otherwise update existing record

---

## Security

### Webhook URL Security

- **Keep webhook URLs private:** Anyone with the URL can send data to your Make.com scenario
- **Use Make.com's built-in security:** Make.com validates webhook sources
- **Monitor delivery logs:** Check for suspicious activity

### Data Privacy

- **GDPR Compliance:** Webhook payloads contain personal data (email, name)
- **Airtable permissions:** Restrict access to your Airtable base
- **Make.com permissions:** Use service accounts with minimal permissions

---

## API Reference (Admin Only)

### List Webhooks

```typescript
const webhooks = await trpc.webhooks.list.query();
```

### Create Webhook

```typescript
const webhook = await trpc.webhooks.create.mutate({
  name: "Onboarding to Airtable",
  eventType: "user.onboarded",
  webhookUrl: "https://hook.us1.make.com/xxxxx",
  isActive: true,
  retryAttempts: 3,
});
```

### Update Webhook

```typescript
const updated = await trpc.webhooks.update.mutate({
  id: 1,
  webhookUrl: "https://hook.us1.make.com/new-url",
  isActive: true,
});
```

### Delete Webhook

```typescript
await trpc.webhooks.delete.mutate({ id: 1 });
```

### View Delivery Logs

```typescript
// All logs
const logs = await trpc.webhooks.logs.query({ limit: 100 });

// Logs for specific webhook
const logs = await trpc.webhooks.logs.query({ 
  webhookConfigId: 1, 
  limit: 50 
});
```

---

## Next Steps

1. âœ… **Set up Make.com webhook** - Create scenario and copy webhook URL
2. âœ… **Configure webhook in database** - Insert webhook config with your URL
3. âœ… **Test onboarding flow** - Complete onboarding and verify webhook delivery
4. âœ… **Map fields in Make.com** - Connect webhook data to Airtable fields
5. âœ… **Activate scenario** - Turn on Make.com scenario for production use
6. ðŸ“Š **Monitor delivery logs** - Check `webhook_delivery_logs` table regularly

---

## Support

**Questions?**
- Check Make.com documentation: https://www.make.com/en/help/modules/webhooks
- Check Airtable API docs: https://airtable.com/developers/web/api/introduction
- Review webhook delivery logs in database for error details

**Need Help?**
- Contact UpsurgeIQ support with webhook configuration questions
- Share Make.com scenario screenshots for troubleshooting
- Provide `webhook_delivery_logs` entries for failed deliveries

---

**Document Version:** 1.0  
**Last Updated:** December 19, 2025  
**Status:** Production Ready âœ…
